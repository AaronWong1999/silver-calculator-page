<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™½é“¶æœŸè´§ï¼šåŠ¨æ€é£æ§ç­–ç•¥è®¡ç®—å™¨ v4.0 (Emailç›‘æ§ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1c1917 0%, #292524 100%);
            min-height: 100vh;
            padding: 20px;
            color: #e7e5e4;
        }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { text-align: center; margin-bottom: 8px; font-size: 26px; color: #facc15; font-weight: 800; letter-spacing: -0.5px; }
        .subtitle { text-align: center; color: #a8a29e; margin-bottom: 25px; font-size: 14px; }
        
        /* é‡‘é“¶æ¯”ç›‘æ§é¢æ¿ */
        .ratio-panel {
            background: rgba(15, 23, 42, 0.6);
            border: 1px solid #475569;
            border-radius: 12px;
            padding: 15px 25px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            backdrop-filter: blur(5px);
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        .ratio-panel.alert-active {
            background: rgba(220, 38, 38, 0.2);
            border-color: #ef4444;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        @keyframes pulse-yellow {
            0% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(250, 204, 21, 0.4)); }
            50% { transform: scale(1.2); filter: drop-shadow(0 0 5px rgba(250, 204, 21, 0.8)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(250, 204, 21, 0.4)); }
        }

        .market-data { display: flex; gap: 30px; align-items: center; z-index: 10; }
        .price-item { display: flex; flex-direction: column; position: relative; width: 120px; }
        .price-label { font-size: 12px; color: #94a3b8; text-transform: uppercase; font-weight: bold; }
        .price-val { font-size: 18px; font-weight: 700; font-family: 'SF Mono', monospace; color: #fff; z-index: 1; }
        .gold-val { color: #facc15; }
        .silver-val { color: #e2e8f0; }

        .hl-label { font-size: 10px; color: #64748b; margin-top: 2px; display: flex; justify-content: space-between; font-family: 'SF Mono', monospace; }
        
        .sparkline {
            height: 30px;
            width: 100%;
            margin-top: 2px;
            opacity: 0.8;
        }
        .sparkline path {
            fill: none;
            stroke-width: 1.5;
            stroke-linecap: round;
            stroke-linejoin: round;
        }

        .ratio-display { text-align: center; z-index: 10; width: 160px; }
        .ratio-val { font-size: 32px; font-weight: 800; color: #38bdf8; line-height: 1.1; }
        .ratio-desc { font-size: 12px; color: #7dd3fc; text-transform: uppercase; letter-spacing: 1px; }

        .ratio-target { display: flex; align-items: center; gap: 10px; background: rgba(0,0,0,0.2); padding: 8px 15px; border-radius: 8px; z-index: 10; }
        .target-input { width: 60px; background: transparent; border: none; border-bottom: 1px solid #94a3b8; color: #fff; text-align: center; font-size: 16px; font-weight: bold; }
        .target-input:focus { outline: none; border-color: #38bdf8; }
        
        /* Bell Icon Styles */
        #alert-icon { 
            font-size: 18px; /* ç¼©å°å›¾æ ‡ */
            cursor: pointer; 
            transition: all 0.3s;
            filter: grayscale(1) opacity(0.5); /* é»˜è®¤ç°è‰² */
            margin-left: 5px; /* å¾®è°ƒé—´è· */
        }
        
        #alert-icon.active {
            filter: none opacity(1); /* æ¢å¤é‡‘è‰² */
            animation: breathe-soft 3s infinite ease-in-out;
        }
        
        #alert-icon.permission-needed {
            filter: none opacity(1);
            animation: pulse-bell 2s infinite;
        }

        @keyframes pulse-bell {
            0% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(250, 204, 21, 0)); }
            50% { transform: scale(1.1); filter: drop-shadow(0 0 5px rgba(250, 204, 21, 0.6)); }
            100% { transform: scale(1); filter: drop-shadow(0 0 0 rgba(250, 204, 21, 0)); }
        }

        @keyframes breathe-soft {
            0% { 
                transform: scale(1); 
                filter: drop-shadow(0 0 0 rgba(250, 204, 21, 0));
                text-shadow: 0 0 0 rgba(250, 204, 21, 0);
            }
            50% { 
                transform: scale(1.08); /* å¾®å¹…å‘¼å¸ */
                filter: drop-shadow(0 0 4px rgba(250, 204, 21, 0.5));
                text-shadow: 0 0 5px rgba(250, 204, 21, 0.3);
            }
            100% { 
                transform: scale(1); 
                filter: drop-shadow(0 0 0 rgba(250, 204, 21, 0));
                text-shadow: 0 0 0 rgba(250, 204, 21, 0);
            }
        }

        /* é¡¶éƒ¨é…ç½®æ  */
        .config-panel {
            background: rgba(30, 41, 59, 0.8);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            flex-wrap: wrap;
        }
        .config-item { display: flex; align-items: center; gap: 10px; }
        .config-label { font-size: 16px; color: #93c5fd; font-weight: bold; }
        .config-input { 
            background: #0f172a; border: 1px solid #3b82f6; color: #fff; 
            padding: 8px 12px; border-radius: 6px; font-size: 18px; width: 100px; text-align: center; font-weight: bold;
        }
        .mode-btn {
            padding: 8px 16px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; transition: all 0.2s;
        }
        .btn-safe { background: rgba(16, 185, 129, 0.2); color: #34d399; border: 1px solid #10b981; }
        .btn-safe.active { background: #10b981; color: #fff; }
        .btn-agg { background: rgba(239, 68, 68, 0.2); color: #f87171; border: 1px solid #ef4444; }
        .btn-agg.active { background: #ef4444; color: #fff; }

        /* åœºæ™¯é€‰æ‹©å™¨ */
        .scenario-switch {
            display: flex; background: rgba(0,0,0,0.3); border-radius: 8px; padding: 2px; border: 1px solid rgba(255,255,255,0.1); margin-left: 15px;
        }
        .scenario-opt {
            padding: 6px 15px; cursor: pointer; border-radius: 6px; font-size: 13px; color: #a8a29e; transition: all 0.2s;
        }
        .scenario-opt:hover { color: #fff; }
        .scenario-opt.active { background: #3b82f6; color: #fff; font-weight: bold; }

        /* çŠ¶æ€æ  */
        .alert-box {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255,255,255,0.1);
            border-left: 5px solid #a8a29e;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 30px;
            transition: all 0.3s;
        }
        .alert-box.safe-mode { border-left-color: #10b981; background: rgba(16, 185, 129, 0.1); }
        .alert-box.agg-mode { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); }

        .strategy-section { 
            background: rgba(255, 255, 255, 0.03);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 30px; 
            border: 1px solid rgba(255,255,255,0.05);
        }
        .section-header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
        }
        .section-title { font-size: 20px; color: #facc15; font-weight: 700; display: flex; align-items: center; }
        
        .params-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-bottom: 20px;
        }
        .param-box {
            background: rgba(0,0,0,0.2); border-radius: 8px; padding: 12px; text-align: center; border: 1px solid rgba(255,255,255,0.05);
        }
        .param-box .label { color: #78716c; font-size: 11px; margin-bottom: 4px; text-transform: uppercase; }
        .param-box .value { color: #fff; font-size: 15px; font-weight: 700; font-family: 'SF Mono', monospace; }

        .formula-box {
            background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6;
            padding: 15px; margin-bottom: 20px; font-size: 13px; color: #dbeafe; border-radius: 0 8px 8px 0;
        }
        .formula-box code { background: rgba(0,0,0,0.3); padding: 2px 6px; border-radius: 4px; color: #ffd700; }

        table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; }
        th {
            background: #292524; padding: 12px 8px; text-align: center; color: #a8a29e;
            font-weight: 600; font-size: 11px; text-transform: uppercase; border-bottom: 1px solid #44403c;
        }
        td { padding: 10px 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); font-variant-numeric: tabular-nums; }
        
        .row-history { background: rgba(107, 114, 128, 0.1); color: #a8a29e; }
        .row-current { background: rgba(239, 68, 68, 0.1); color: #fff; font-weight: bold; border: 1px solid #ef4444; }
        .row-future { background: rgba(255, 255, 255, 0.02); }
        .row-trigger { background: rgba(16, 185, 129, 0.15); color: #4ade80; font-weight: bold; }
        .row-ideal { background: rgba(59, 130, 246, 0.05); color: #93c5fd; font-style: italic; }
        
        .txt-red { color: #ef4444; }
        .txt-green { color: #4ade80; }
        .txt-yellow { color: #facc15; }
        .txt-blue { color: #60a5fa; }

        /* === ç§»åŠ¨ç«¯é€‚é… === */
        .table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch; /* iOSé¡ºæ»‘æ»šåŠ¨ */
            margin-bottom: 10px;
            border-radius: 8px;
            background: rgba(0,0,0,0.1);
        }

        @media (max-width: 768px) {
            body { padding: 10px 5px; }
            h1 { font-size: 22px; margin-top: 5px; }
            .subtitle { font-size: 12px; margin-bottom: 15px; }
            .container { padding: 0; }
            
            /* Ratio Panel Mobile */
            .ratio-panel { flex-direction: column; gap: 20px; padding: 15px; }
            .market-data { width: 100%; justify-content: space-between; gap: 0; }
            .price-item { width: 48%; text-align: center; }
            .price-item .price-val { font-size: 20px; }
            .sparkline { height: 40px; }
            .ratio-display { width: 100%; margin: 5px 0; }
            .ratio-val { font-size: 42px; }
            .ratio-target { width: 100%; justify-content: center; padding: 12px; margin-top: 5px; }
            .target-input { font-size: 18px; width: 80px; }

            /* Config Panel Mobile */
            .config-panel { padding: 15px; gap: 12px; }
            .config-item { 
                width: 100%; 
                justify-content: space-between; 
                background: rgba(0,0,0,0.2); 
                padding: 10px 15px; 
                border-radius: 8px; 
            }
            .config-label { font-size: 14px; }
            .config-input { width: 100px; font-size: 16px; height: 36px; } /* 16pxé˜²æ­¢iOSè‡ªåŠ¨æ”¾å¤§ */
            
            /* Mode Buttons */
            .config-item:last-child { background: transparent; padding: 0; gap: 10px; }
            .mode-btn { flex: 1; padding: 12px 0; font-size: 14px; }
            
            /* Section Layout */
            .strategy-section { padding: 15px; border-radius: 12px; }
            .section-header { flex-direction: column; align-items: flex-start; gap: 12px; padding-bottom: 12px; margin-bottom: 15px; }
            .section-title { 
                font-size: 18px; 
                width: 100%; 
                display: flex; 
                flex-direction: column; 
                gap: 10px; 
                align-items: center; 
            }
            .scenario-switch { margin-left: 0; width: 100%; justify-content: center; }
            .scenario-opt { flex: 1; text-align: center; padding: 8px 0; }
            
            /* Grid & Tables */
            .params-grid { grid-template-columns: 1fr 1fr; gap: 8px; }
            .param-box { padding: 10px 5px; }
            .param-box .value { font-size: 14px; }
            
            th, td { padding: 10px 6px; font-size: 12px; white-space: nowrap; }
            
            /* Hide non-critical columns on extremely small screens if needed, 
               but horizontal scroll covers this. */
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ç™½é“¶æœŸè´§ï¼šåŠ¨æ€é£æ§ç­–ç•¥è®¡ç®—å™¨ v4.0</h1>
        <p class="subtitle">ä¸€ä»½ä»£ç ï¼Œå¹³è¡Œå®‡å®™ã€‚è°ƒæ•´æŠ—è·Œç³»æ•°ï¼Œå¯¹æ¯”ç†æƒ³ä¸ç°å®ã€‚</p>

        <!-- é‡‘é“¶æ¯”ç›‘æ§é¢æ¿ -->
        <div id="ratioPanel" class="ratio-panel">
            <div class="market-data">
                <div class="price-item">
                    <span class="price-label">Gold (XAU)</span>
                    <span class="price-val gold-val" id="price-xau">Loading...</span>
                    <svg class="sparkline" id="spark-xau"></svg>
                    <div class="hl-label" id="hl-xau"><span>H:-</span><span>L:-</span></div>
                </div>
                <div class="price-item">
                    <span class="price-label">Silver (XAG)</span>
                    <span class="price-val silver-val" id="price-xag">Loading...</span>
                    <svg class="sparkline" id="spark-xag"></svg>
                    <div class="hl-label" id="hl-xag"><span>H:-</span><span>L:-</span></div>
                </div>
            </div>
            
            <div class="ratio-display">
                <div class="ratio-val" id="ratio-val">--.--</div>
                <div class="ratio-desc">å½“å‰é‡‘é“¶æ¯” (Gold/Silver Ratio)</div>
                <svg class="sparkline" id="spark-ratio"></svg>
                <div class="hl-label" id="hl-ratio" style="justify-content: center; gap: 10px;"><span>H:-</span><span>L:-</span></div>
            </div>

            <div class="ratio-target">
                <span style="font-size: 13px; color: #94a3b8;">æé†’é˜ˆå€¼:</span>
                <input type="number" id="targetRatio" class="target-input" value="44" step="0.5" onchange="checkRatio()">
                <div id="alert-icon" onclick="requestNotifyPermission()" title="ç‚¹å‡»å¼€å¯å¼¹çª—é€šçŸ¥">ğŸ””</div>
            </div>
        </div>

        <!-- é‚®ä»¶é€šçŸ¥é…ç½®é¢æ¿ (v4.0æ–°å¢) -->
        <div class="mb-6 p-4 rounded-xl border border-gray-700 bg-gray-900/50 backdrop-blur-sm">
            <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2">
                    <span class="text-lg font-bold text-gray-300">ğŸ“§ é‚®ä»¶æŠ¥è­¦è®¾ç½®</span>
                    <span id="email-status-icon" class="text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-400">æœªé…ç½®</span>
                </div>
                <button onclick="toggleEmailConfig()" class="text-xs text-sky-400 hover:text-sky-300">å±•å¼€/æŠ˜å </button>
            </div>
            
            <div id="emailConfigPanel" class="hidden space-y-3 mt-4">
                <div class="text-xs text-gray-500 mb-2">
                    <p>ä½¿ç”¨ EmailJS å‘é€é€šçŸ¥ã€‚è¯·è‡ªè¡Œæ³¨å†Œ <a href="https://www.emailjs.com/" target="_blank" class="text-sky-400 underline">EmailJS</a> å…è´¹è´¦å·ã€‚</p>
                    <p>æ•°æ®ä»…ä¿å­˜åœ¨æ‚¨æœ¬åœ°æµè§ˆå™¨ï¼Œä¸ä¼šä¸Šä¼ æœåŠ¡å™¨ã€‚</p>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Service ID</label>
                        <input type="text" id="email_service_id" class="w-full bg-stone-900 border border-stone-700 rounded px-2 py-1 text-sm text-gray-300 focus:border-sky-500 outline-none" placeholder="service_xxx">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Template ID</label>
                        <input type="text" id="email_template_id" class="w-full bg-stone-900 border border-stone-700 rounded px-2 py-1 text-sm text-gray-300 focus:border-sky-500 outline-none" placeholder="template_xxx">
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">Public Key</label>
                        <input type="text" id="email_public_key" class="w-full bg-stone-900 border border-stone-700 rounded px-2 py-1 text-sm text-gray-300 focus:border-sky-500 outline-none" placeholder="ç”¨æˆ·å…¬é’¥">
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">æ¥æ”¶é‚®ç®±</label>
                        <input type="email" id="email_to_address" class="w-full bg-stone-900 border border-stone-700 rounded px-2 py-1 text-sm text-gray-300 focus:border-sky-500 outline-none" placeholder="your@email.com">
                    </div>
                </div>

                <div class="flex justify-between items-center pt-2 border-t border-stone-700 mt-2">
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="email_enabled" class="w-4 h-4 rounded bg-stone-800 border-stone-600 accent-sky-500">
                        <label for="email_enabled" class="text-sm text-gray-300 cursor-pointer select-none">å¯ç”¨é‚®ä»¶æŠ¥è­¦</label>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="saveEmailConfig()" class="px-3 py-1.5 bg-sky-600 hover:bg-sky-500 text-white rounded text-xs font-bold transition-colors">ä¿å­˜é…ç½®</button>
                        <button onclick="testEmail()" class="px-3 py-1.5 bg-stone-700 hover:bg-stone-600 text-white rounded text-xs font-bold transition-colors">æµ‹è¯•é‚®ä»¶</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- èµ„é‡‘é…ç½®åŒºåŸŸ (Restored Class) -->
        <div class="config-panel">

            <div class="config-item">
                <span class="config-label">è®¾å®šæŠ—è·Œå›æ’¤:</span>
                <input type="number" id="safetyRate" class="config-input" value="15" step="1" min="5" max="50" onchange="recalc()">
                <span class="config-label">%</span>
            </div>
            <div class="config-item">
                <span class="config-label">å›½å†…ä¿è¯é‡‘:</span>
                <input type="number" id="cnMarginRate" class="config-input" value="18.35" step="0.01" onchange="recalc()">
                <span class="config-label">%</span>
            </div>
            <div class="config-item">
                <span class="config-label">MooMooä¿è¯é‡‘:</span>
                <input type="number" id="mooMarginRate" class="config-input" value="12.66" step="0.01" onchange="recalc()">
                <span class="config-label">%</span>
            </div>
            <div class="config-item">
                <span class="config-label">CNæœ¬é‡‘:</span>
                <input type="number" id="cnPrincipal" class="config-input" value="250000" step="10000" style="color:#fbbf24" onchange="recalc()">
            </div>
            <div class="config-item">
                <span class="config-label">Mooæœ¬é‡‘:</span>
                <input type="number" id="mooPrincipal" class="config-input" value="24979.24" step="1000" style="color:#fbbf24" onchange="recalc()">
            </div>
            <div class="config-item">
                <span class="config-label">èµ„é‡‘è°ƒæ•´(CN):</span>
                <input type="number" id="cnAdj" class="config-input" value="0" step="10000" style="color:#f87171" onchange="recalc()">
            </div>
            <div class="config-item">
                <span class="config-label">èµ„é‡‘è°ƒæ•´(Moo):</span>
                <input type="number" id="mooAdj" class="config-input" value="0" step="1000" style="color:#f87171" onchange="recalc()">
            </div>
            <div class="config-item">
                <button class="mode-btn btn-agg" onclick="setMode(10)">ğŸ”¥ æ¿€è¿› (10%)</button>
                <button class="mode-btn btn-safe active" onclick="setMode(15)">ğŸ›¡ï¸ ç¨³å¥ (15%)</button>
            </div>
        </div>

        <div id="alertBox" class="alert-box"></div>

        <!-- å›½å†…ç‰ˆ -->
        <div class="strategy-section">
            <div class="section-header">
                <div class="section-title">
                    å›½å†…ç‰ˆï¼ˆä¸ŠæœŸæ‰€ AGï¼‰
                    <div class="scenario-switch">
                        <div id="cn-scen-real" class="scenario-opt active" onclick="setScenario('cn', 'real')">ğŸ”´ ç°å®æ¨¡å¼</div>
                        <div id="cn-scen-ideal" class="scenario-opt" onclick="setScenario('cn', 'ideal')">ğŸ”µ ç†æƒ³æ¨¡å¼</div>
                    </div>
                </div>
                <div id="cn-status" class="section-status"></div>
            </div>
            <div class="params-grid">
                <div class="param-box"><div class="label">æŒä»“æ‰‹æ•°</div><div class="value" id="cn-curr-lots">5æ‰‹</div></div>
                <div class="param-box"><div class="label">å½“å‰å‡€å€¼</div><div class="value" id="cn-curr-equity">Â¥482,581</div></div>
                <div class="param-box"><div class="label">çˆ†ä»“ä»·æ ¼</div><div class="value danger" id="cn-boom-price">-</div></div>
                <div class="param-box"><div class="label">ä¸‹ä¸ªåŠ ä»“ä»·</div><div class="value highlight" id="cn-next-price">-</div></div>
                <div class="param-box"><div class="label">æœ€ç»ˆæ”¶ç›Š</div><div class="value" id="cn-final-equity">-</div></div>
            </div>
            <div class="formula-box" id="cn-formula"></div>
            <div class="table-wrapper">
                <table id="cn-table">
                    <thead>
                        <tr>
                            <th>è½®æ¬¡</th><th>çŠ¶æ€</th><th>è§¦å‘ä»·æ ¼</th><th>æ“ä½œ</th><th>æ€»æŒä»“</th><th>æŒä»“å‡ä»·</th><th>è´¦æˆ·ä½™é¢</th>
                            <th>ä¿æœ¬ä»·</th><th>å®‰å…¨å«</th><th>çˆ†ä»“ä»·</th><th>éœ€è¡¥ä¿</th><th>æŠ—è·Œèƒ½åŠ›</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <!-- MooMooç‰ˆ -->
        <div class="strategy-section">
            <div class="section-header">
                <div class="section-title">
                    MooMooç‰ˆï¼ˆCOMEX SIL 1000ozï¼‰
                    <div class="scenario-switch">
                        <div id="moo-scen-real" class="scenario-opt active" onclick="setScenario('moo', 'real')">ğŸ”´ ç°å®æ¨¡å¼</div>
                        <div id="moo-scen-ideal" class="scenario-opt" onclick="setScenario('moo', 'ideal')">ğŸ”µ ç†æƒ³æ¨¡å¼</div>
                    </div>
                </div>
                <div id="moo-status" class="section-status"></div>
            </div>
            <div class="params-grid">
                <div class="param-box"><div class="label">æŒä»“æ‰‹æ•°</div><div class="value" id="moo-curr-lots">6æ‰‹</div></div>
                <div class="param-box"><div class="label">å½“å‰å‡€å€¼</div><div class="value" id="moo-curr-equity">$163,144</div></div>
                <div class="param-box"><div class="label">çˆ†ä»“ä»·æ ¼</div><div class="value danger" id="moo-boom-price">-</div></div>
                <div class="param-box"><div class="label">ä¸‹ä¸ªåŠ ä»“ä»·</div><div class="value highlight" id="moo-next-price">-</div></div>
                <div class="param-box"><div class="label">æœ€ç»ˆæ”¶ç›Š</div><div class="value" id="moo-final-equity">-</div></div>
            </div>
            <div class="formula-box" id="moo-formula"></div>
            <div class="table-wrapper">
                <table id="moo-table">
                    <thead>
                        <tr>
                            <th>è½®æ¬¡</th><th>çŠ¶æ€</th><th>è§¦å‘ä»·æ ¼</th><th>æ“ä½œ</th><th>æ€»æŒä»“</th><th>æŒä»“å‡ä»·</th><th>è´¦æˆ·ä½™é¢</th>
                            <th>ä¿æœ¬ä»·</th><th>å®‰å…¨å«</th><th>çˆ†ä»“ä»·</th><th>éœ€è¡¥ä¿</th><th>æŠ—è·Œèƒ½åŠ›</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // === åŸºç¡€æ•°æ®é…ç½® ===
        const HISTORY = {
            cn: [
                { round: 1, price: 15869, lots: 3, equity: 243414, note: "åˆå§‹å…¥é‡‘" },
                { round: 2, price: 16785, lots: 4, equity: 284619, note: "ç›ˆåˆ©æ»šä»“" },
                { round: 3, price: 17416, lots: 4, equity: 322477, note: "æŒæœ‰è§‚æœ›" },
                { round: 4, price: 17979, lots: 5, equity: 356272, note: "æ¿€è¿›åŠ ä»“æœŸ" },
                { round: 5, price: 20790, lots: 5, equity: 510449, note: "è°ƒæ•´æŒä»“" },
                { round: 6, price: 20810, lots: 6, equity: 512789, note: "ç¨³å¥åŠ ä»“" },
                { round: 7, price: 22280, lots: 7, equity: 642177, note: "é¡ºåŠ¿åŠ ä»“" },
                { round: 8, price: 23966, lots: 8, equity: 821304, note: "è·Ÿéšè¶‹åŠ¿" },
                { round: 9, price: 25387, lots: 9, equity: 1044455, note: "é«˜ä½åŠ ä»“" },
                { round: 10, price: 27288, lots: 10, equity: 1243770, note: "å†åˆ›æ–°é«˜" },
                { round: 11, price: 27453, lots: 11, equity: 1271829, note: "ä¹˜èƒœè¿½å‡»" },
                { round: 12, price: 29820, lots: 12, equity: 1667000, note: "å›è°ƒåŠ ä»“" },
                { round: 13, price: 29850, lots: 13, equity: 1691679, note: "åŠ¿å¦‚ç ´ç«¹" },
                { round: 14, price: 30445, lots: 14, equity: 2168101.69, note: "é¡ºåŠ¿åŠ ä»“" },
                { round: 15, price: 25500, lots: 0, equity: 1129651.69, note: "æ­¢ç›ˆç¦»åœº | æœ€ç»ˆæˆ˜æœ: ç›ˆåˆ© Â¥879,651.69" }
            ],
            moo: [
                { round: 1, price: 76.245, lots: 2, equity: 19884, note: "åˆå§‹æŒä»“" },
                { round: 2, price: 90.95, lots: 3, equity: 59593, note: "é«˜ä½åŠ ä»“" },
                { round: 3, price: 101.365, lots: 4, equity: 93895, note: "é«˜ä½è¿½æ¶¨" },
                { round: 4, price: 109.1, lots: 5, equity: 124835, note: "åŠ¨æ€åŠ ä»“" },
                { round: 5, price: 115.995, lots: 6, equity: 159310, note: "é«˜ä½åŠ ä»“" },
                { round: 6, price: 120.97, lots: 7, equity: 151341.13, note: "è·ŸéšåŠ ä»“" },
                { round: 7, price: 109.1, lots: 6, equity: 107288.12, note: "é¿é™©å‡ä»“ (ä¿æœ¬98.6)" },
                { round: 8, price: 104.74, lots: 0, equity: 79520.06, note: "æ­¢æŸç¦»åœº | æœ€ç»ˆæˆ˜æœ: ç›ˆåˆ© $54,520.06" }
            ]
        };

        const CONFIG = {
            cn: {
                startPrice: 15869, startEquity: 243414, startLots: 3,
                currentPrice: 25500, currentEquity: 1129651.69, currentLots: 0, currentAvgPrice: 0,
                marginRate: 0.1835, contractSize: 15,
                boomCoef: 0.8165
            },

            moo: {
                startPrice: 69.00, startEquity: 12984, startLots: 1,
                currentPrice: 104.74, currentEquity: 79520.06, currentLots: 0, currentAvgPrice: 0,
                marginRate: 0.1266, contractSize: 1000,
                boomCoef: 0.8734
            }
        };

        let state = {
            cn: 'real',
            moo: 'real'
        };

        // === é‚®ä»¶æŠ¥è­¦ç³»ç»Ÿ (v4.0) ===
        const EMAIL_STORAGE_KEY = 'silver_calc_email_v4';
        const ALERT_COOLDOWN = 3600 * 1000; // 1å°æ—¶å†·å´
        let lastAlertTime = {
            ratio: 0,
            cn_buy: 0,
            cn_boom: 0,
            moo_buy: 0,
            moo_boom: 0
        };

        function toggleEmailConfig() {
            const panel = document.getElementById('emailConfigPanel');
            panel.classList.toggle('hidden');
        }

        function loadEmailConfig() {
            const saved = localStorage.getItem(EMAIL_STORAGE_KEY);
            if (saved) {
                const cfg = JSON.parse(saved);
                document.getElementById('email_service_id').value = cfg.service_id || '';
                document.getElementById('email_template_id').value = cfg.template_id || '';
                document.getElementById('email_public_key').value = cfg.public_key || '';
                document.getElementById('email_to_address').value = cfg.to_email || '';
                document.getElementById('email_enabled').checked = cfg.enabled || false;
                
                if (cfg.public_key) emailjs.init(cfg.public_key);
                updateEmailStatusUI(cfg.enabled);
            }
        }

        function saveEmailConfig() {
            const cfg = {
                service_id: document.getElementById('email_service_id').value,
                template_id: document.getElementById('email_template_id').value,
                public_key: document.getElementById('email_public_key').value,
                to_email: document.getElementById('email_to_address').value,
                enabled: document.getElementById('email_enabled').checked
            };
            
            localStorage.setItem(EMAIL_STORAGE_KEY, JSON.stringify(cfg));
            if (cfg.public_key) emailjs.init(cfg.public_key);
            updateEmailStatusUI(cfg.enabled);
            alert("é…ç½®å·²ä¿å­˜ï¼");
        }

        function updateEmailStatusUI(enabled) {
            const icon = document.getElementById('email-status-icon');
            if (enabled) {
                icon.innerText = "ç›‘æ§ä¸­";
                icon.className = "text-xs px-2 py-0.5 rounded bg-green-900 text-green-300 border border-green-700";
            } else {
                icon.innerText = "å·²ç¦ç”¨";
                icon.className = "text-xs px-2 py-0.5 rounded bg-gray-700 text-gray-400";
            }
        }

        async function sendEmailAlert(subject, message, type) {
            const cfg = JSON.parse(localStorage.getItem(EMAIL_STORAGE_KEY) || '{}');
            if (!cfg.enabled || !cfg.service_id || !cfg.template_id) return;

            const now = Date.now();
            if (now - lastAlertTime[type] < ALERT_COOLDOWN) {
                console.log(`Alert ${type} is in cooldown.`);
                return;
            }

            const templateParams = {
                to_email: cfg.to_email,
                subject: subject,
                message: message,
                time: new Date().toLocaleString()
            };

            try {
                await emailjs.send(cfg.service_id, cfg.template_id, templateParams);
                console.log("Email sent successfully!");
                lastAlertTime[type] = now;
                // æµè§ˆå™¨é€šçŸ¥ä½œä¸ºè¾…åŠ©
                new Notification("ğŸ“§ é‚®ä»¶å·²å‘é€", { body: subject });
            } catch (error) {
                console.error("Email send failed:", error);
            }
        }

        function testEmail() {
            sendEmailAlert("ã€æµ‹è¯•ã€‘ç™½é“¶è®¡ç®—å™¨ v4.0", "è¿™æ˜¯ä¸€æ¡æµ‹è¯•é‚®ä»¶ï¼Œè¯´æ˜æ‚¨çš„é…ç½®æ­£ç¡®ã€‚", "test");
            alert("æµ‹è¯•è¯·æ±‚å·²å‘é€ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°æˆ–é‚®ç®±ã€‚");
        }

        // === è¾…åŠ©åŠŸèƒ½ï¼šToast é€šçŸ¥ (å…¼å®¹ç§»åŠ¨ç«¯) ===
        function showToast(msg, type = 'info') {
            let container = document.getElementById('toast-container');
            if (!container) {
                container = document.createElement('div');
                container.id = 'toast-container';
                container.style.cssText = "position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; pointer-events: none;";
                document.body.appendChild(container);
            }

            const toast = document.createElement('div');
            // Tailwind classes for toast
            const colors = type === 'alert' ? 'bg-red-600' : (type === 'success' ? 'bg-green-600' : 'bg-blue-600');
            toast.className = `${colors} text-white px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 transition-all duration-500 opacity-0 translate-y-[-20px]`;
            toast.style.pointerEvents = "auto";
            toast.innerHTML = `<span>${type === 'alert' ? 'ğŸš¨' : 'ğŸ””'}</span> <span class="font-bold text-sm">${msg}</span>`;

            container.appendChild(toast);

            // Animation In
            requestAnimationFrame(() => {
                toast.classList.remove('opacity-0', 'translate-y-[-20px]');
            });

            // Auto Remove
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-[-20px]');
                setTimeout(() => toast.remove(), 500);
            }, 5000);
        }

        // === æ ¸å¿ƒé€»è¾‘ï¼šä»·æ ¼ç›‘æ§ä¸æŠ¥è­¦ ===
        function checkPriceAlerts(currentRatio) {
            // Helper to parse price strings like "$135.00" or "Â¥25,107"
            const parseVal = (id) => {
                const el = document.getElementById(id);
                if (!el) return null;
                const txt = el.innerText.replace(/[Â¥$,\s]/g, '');
                if (txt === '-' || txt === 'Loading...') return null;
                return parseFloat(txt);
            };

            // 1. é‡‘é“¶æ¯”æ£€æŸ¥
            const targetRatio = parseFloat(document.getElementById('targetRatio').value) || 44;
            if (currentRatio && currentRatio <= targetRatio) {
                const msg = `å½“å‰é‡‘é“¶æ¯” ${currentRatio.toFixed(2)} å·²ä½äºè®¾å®šå€¼ ${targetRatio}`;
                sendEmailAlert(`ğŸš¨ é‡‘é“¶æ¯”æœºä¼šæé†’: ${currentRatio.toFixed(2)}`, msg, 'ratio');
                // ä»…åœ¨é¦–æ¬¡è§¦å‘æˆ–å†·å´åå¼¹çª—ï¼Œé¿å…åˆ·å± (é€»è¾‘åœ¨ sendEmailAlert é‡Œæœ‰å†·å´ï¼Œè¿™é‡Œ Toast ä¹Ÿå¯å¤ç”¨)
                const now = Date.now();
                if (now - lastAlertTime['ratio'] < 5000) showToast(msg, 'success'); 
            }

            // è·å–å®æ—¶ä»·æ ¼ (Moo = Silver, CN = Estimate)
            // æ³¨æ„ï¼šfetchPrices æ›´æ–°äº† CONFIG.moo.currentPriceï¼Œä½†æˆ‘ä»¬ç›´æ¥ç”¨ currentSilver å˜é‡æ›´ç›´æ¥
            // å¿…é¡»ç¡®ä¿ fetchPrices ä¸­çš„ currentSilver æ˜¯å…¨å±€å¯è®¿é—®çš„ï¼Œæˆ–è€…ç”±å‚æ•°ä¼ å…¥ã€‚
            // è¿™é‡Œçš„ CONFIG.moo.currentPrice åœ¨ fetchPrices ä¸­è¢«æ›´æ–°äº†ï¼Œæ‰€ä»¥å¯ç”¨ã€‚
            const liveMooPrice = CONFIG.moo.currentPrice; 
            
            // ä¼°ç®—å›½å†…é“¶ä»· (ç®€å•ç®—æ³•ï¼šå›½é™…é“¶ä»· * 7.25æ±‡ç‡ * 32.15ç›å¸/åƒå…‹)
            // ä¸ºäº†æ›´å‡†ï¼Œå¯ä»¥ä½¿ç”¨ (CN_Input_Price / Moo_Input_Price) çš„æ¯”ä¾‹æ¥æ¨ç®—ï¼Œæˆ–è€…å›ºå®šæ±‡ç‡ã€‚
            // é‰´äºç”¨æˆ·å¯èƒ½åœ¨å¹³è¡Œå®‡å®™ï¼Œæˆ‘ä»¬ç”¨ CONFIG é‡Œçš„å½“å‰ä»·æ¯”ä¾‹æ¥ä¿®æ­£ï¼Ÿ
            // ä¸ï¼ŒæŠ¥è­¦åº”è¯¥åŸºäºçœŸå®å¸‚åœºã€‚å‡è®¾æ±‡ç‡ 7.3 (ä¿å®ˆ)
            const liveCnPrice = liveMooPrice * 7.3 * 32.15; 

            const checks = [
                { type: 'moo', livePrice: liveMooPrice, name: 'MooMoo' },
                { type: 'cn', livePrice: liveCnPrice, name: 'å›½å†…ç‰ˆ' }
            ];

            checks.forEach(c => {
                if (!c.livePrice) return;

                const boomPrice = parseVal(`${c.type}-boom-price`);
                const nextPrice = parseVal(`${c.type}-next-price`);

                // A) çˆ†ä»“é¢„è­¦ (ä»·æ ¼ä¸‹è·Œæ¥è¿‘çˆ†ä»“ä»·)
                // è§¦å‘æ¡ä»¶ï¼šå½“å‰ä»· <= çˆ†ä»“ä»· * 1.02 (2% ç¼“å†²)
                if (boomPrice && c.livePrice <= boomPrice * 1.02) {
                    const diff = ((c.livePrice - boomPrice) / boomPrice * 100).toFixed(2);
                    const msg = `${c.name} ä¸¥é‡é£é™©ï¼å½“å‰ä»· ${c.livePrice.toFixed(2)} è·ç¦»çˆ†ä»“ä»…å‰© ${diff}%`;
                    sendEmailAlert(`ğŸ”¥ ${c.name} çˆ†ä»“é¢„è­¦`, msg, `${c.type}_boom`);
                    
                    const now = Date.now();
                    if (now - lastAlertTime[`${c.type}_boom`] < 5000) showToast(msg, 'alert');
                }

                // B) è¡¥ä»“æé†’ (ä»·æ ¼ä¸Šæ¶¨æ¥è¿‘ä¸‹ä¸€åŠ ä»“ä»·)
                // è§¦å‘æ¡ä»¶ï¼šå½“å‰ä»· >= ä¸‹ä¸€ä»· * 0.995 (0.5% ç¼“å†²ï¼Œå³å°†åˆ°è¾¾)
                // æ³¨æ„ï¼šå‰ææ˜¯ ä¸‹ä¸€ä»· > å½“å‰æŒä»“å‡ä»· (é‡‘å­—å¡”åŠ ä»“é€»è¾‘)
                // å¦‚æœæ˜¯è¡¥è·Œåå¼¹ï¼Œé€»è¾‘å¯èƒ½ä¸åŒã€‚è¿™é‡ŒæŒ‰"ä¸Šæ¶¨è§¦å‘åŠ ä»“"é€»è¾‘ã€‚
                if (nextPrice && c.livePrice >= nextPrice * 0.995) {
                    const msg = `${c.name} åŠ ä»“æœºä¼šï¼å½“å‰ä»· ${c.livePrice.toFixed(2)} å³å°†åˆ°è¾¾ ${nextPrice}`;
                    sendEmailAlert(`ğŸ“ˆ ${c.name} åŠ ä»“æé†’`, msg, `${c.type}_buy`);
                    
                    const now = Date.now();
                    if (now - lastAlertTime[`${c.type}_buy`] < 5000) showToast(msg, 'success');
                }
            });
        }

        // === é‡‘é“¶æ¯”å®æ—¶ç›‘æ§ ===
        let currentGold = 0;
        let currentSilver = 0;
        let lastNotifyTime = 0;
        
        // å†å²æ•°æ®å­˜å‚¨ï¼ˆæœ€è¿‘1440ä¸ªç‚¹ = 4å°æ—¶ï¼‰
        const historyData = {
            gold: [],
            silver: [],
            ratio: []
        };
        const MAX_HISTORY = 1440;

        // [æ–°å¢] å°è¯•ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²æ•°æ®
        try {
            const saved = localStorage.getItem('silver_calc_history_v3');
            if (saved) {
                const parsed = JSON.parse(saved);
                // Filter out invalid values (null, 0, or non-positive) to fix "L:0.00" bug
                if (parsed.gold) historyData.gold = parsed.gold.filter(v => v > 0);
                if (parsed.silver) historyData.silver = parsed.silver.filter(v => v > 0);
                if (parsed.ratio) historyData.ratio = parsed.ratio.filter(v => v > 0);
            }
        } catch (e) { console.error("Load history failed", e); }

        async function fetchPrices() {
            try {
                // ä½¿ç”¨ Binance Futures API
                const [goldRes, silverRes] = await Promise.all([
                    fetch('https://fapi.binance.com/fapi/v1/ticker/price?symbol=XAUUSDT'),
                    fetch('https://fapi.binance.com/fapi/v1/ticker/price?symbol=XAGUSDT')
                ]);

                const goldData = await goldRes.json();
                const silverData = await silverRes.json();

                currentGold = parseFloat(goldData.price);
                currentSilver = parseFloat(silverData.price);

                if (isNaN(currentGold) || currentGold <= 0 || isNaN(currentSilver) || currentSilver <= 0) {
                    throw new Error("Invalid price data");
                }

                const currentRatio = currentGold / currentSilver;

                // [v4.0] Update Global CONFIG with live prices for alert checking
                // Note: CN price is estimated based on Moo price if real CN data isn't fetched separately
                // Assuming a rough exchange rate logic or manual sync, but here we can try to auto-update
                // if the user wants 'Current Price' to reflect market.
                // However, user usually inputs their 'Avg Price'. 
                // Let's just update the 'currentPrice' field in CONFIG for the sake of the alert check logic.
                
                CONFIG.moo.currentPrice = currentSilver;
                // Estimate CN price: Silver * 7.25 * 1000 / 31.1035 (approx conversion) or just ratio
                // Or better: keep the manual input logic for the TABLE, but use live price for ALERTS.
                // Actually, let's trust the 'CN' price is derived or fetched. 
                // Since we don't have a direct CN Futures API here, we'll estimate it:
                // International Silver ($/oz) * USDCNY (~7.3) / 31.1035 * 1000 = CN Price (Yuan/kg)
                // Let's use a fixed rate 7.3 for safety, or just ignore CN auto-update if not reliable.
                // For now, let's update Moo price.
                
                // Trigger v4.0 Email Check
                checkPriceAlerts(currentRatio);

                // æ›´æ–°å†å²æ•°æ®
                updateHistory(historyData.gold, currentGold);
                updateHistory(historyData.silver, currentSilver);
                updateHistory(historyData.ratio, currentRatio);

                // [æ–°å¢] ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                try {
                    localStorage.setItem('silver_calc_history_v3', JSON.stringify(historyData));
                } catch (e) {
                    console.warn("LocalStorage failed:", e);
                }

                updateRatioUI(currentRatio);
                
                // ç»˜åˆ¶å°å›¾è¡¨ (ä¼ å…¥å¯¹åº”çš„ label ID)
                try {
                    drawSparkline('spark-xau', 'hl-xau', historyData.gold, '#facc15');
                    drawSparkline('spark-xag', 'hl-xag', historyData.silver, '#e2e8f0');
                    drawSparkline('spark-ratio', 'hl-ratio', historyData.ratio, '#38bdf8');
                } catch (e) {
                    console.error("Draw error", e);
                }

            } catch (e) {
                console.error("Fetch Error:", e);
                document.getElementById('ratio-val').innerText = "Err";
            }
        }

        function updateHistory(arr, val) {
            arr.push(val);
            if (arr.length > MAX_HISTORY) arr.shift();
        }

        function drawSparkline(svgId, labelId, data, color) {
            // Filter invalid data for display safety
            const validData = data.filter(v => typeof v === 'number' && !isNaN(v) && v > 0);
            if (validData.length < 2) return;
            
            const svg = document.getElementById(svgId);
            const width = svg.clientWidth || 100;
            const height = svg.clientHeight || 30;
            
            // Use loop instead of spread for better performance/safety on large arrays
            let min = validData[0];
            let max = validData[0];
            for (let i = 1; i < validData.length; i++) {
                if (validData[i] < min) min = validData[i];
                if (validData[i] > max) max = validData[i];
            }
            
            // æ›´æ–° High/Low æ ‡ç­¾
            if (document.getElementById(labelId)) {
                document.getElementById(labelId).innerHTML = `<span>H:${max.toFixed(2)}</span><span>L:${min.toFixed(2)}</span>`;
            }

            const range = max - min || 1; // é˜²æ­¢é™¤é›¶
            
            // ç®€å•çš„é™é‡‡æ ·ä»¥ä¼˜åŒ–æ¸²æŸ“
            // ç›®æ ‡ï¼šåœ¨å±å¹•ä¸Šç»˜åˆ¶ä¸è¶…è¿‡ 200 ä¸ªå…³é”®ç‚¹
            let renderData = validData;
            const step = Math.ceil(data.length / 200); 
            if (step > 1) {
                renderData = data.filter((_, i) => i % step === 0);
            }
            
            // ç”Ÿæˆè·¯å¾„ç‚¹
            const points = renderData.map((val, idx) => {
                const x = (idx / (renderData.length - 1)) * width;
                const y = height - ((val - min) / range) * height; // Yè½´åè½¬
                return `${x},${y}`;
            }).join(' ');

            svg.innerHTML = `<path d="M ${points}" stroke="${color}" fill="none" />`;
        }

        function updateRatioUI(ratio) {
            if (!currentGold || !currentSilver) return;

            document.getElementById('price-xau').innerText = `$${currentGold.toFixed(2)}`;
            document.getElementById('price-xag').innerText = `$${currentSilver.toFixed(3)}`;
            document.getElementById('ratio-val').innerText = ratio.toFixed(2);

            checkRatio(ratio);
        }

        function checkPermissionStatus() {
             if (!("Notification" in window)) return;
             
             const icon = document.getElementById('alert-icon');
             if (!icon) return;

             if (Notification.permission === "default") {
                 icon.classList.add('permission-needed');
                 icon.classList.remove('active');
                 icon.title = "ç‚¹å‡»å¼€å¯é€šçŸ¥æƒé™ï¼ˆå¼ºçƒˆå»ºè®®å¼€å¯ï¼‰";
             } else if (Notification.permission === "granted") {
                 icon.classList.remove('permission-needed');
                 icon.classList.add('active'); // å¸¸äº®é‡‘è‰²ï¼Œè¡¨ç¤ºç›‘æ§å·²å°±ç»ª
                 icon.title = "é€šçŸ¥æƒé™å·²å¼€å¯ï¼Œç›‘æ§ä¸­...";
             } else {
                 icon.classList.remove('permission-needed');
                 icon.classList.remove('active');
             }
        }

        function requestNotifyPermission() {
            if (!("Notification" in window)) {
                alert("æ­¤æµè§ˆå™¨ä¸æ”¯æŒæ¡Œé¢é€šçŸ¥");
            } else {
                Notification.requestPermission().then(function (permission) {
                    checkPermissionStatus();
                    if (permission === "granted") {
                        new Notification("é€šçŸ¥æƒé™å·²å¼€å¯ï¼", { body: "å½“é‡‘é“¶æ¯”è¾¾åˆ°é˜ˆå€¼æ—¶ä½ ä¼šæ”¶åˆ°æé†’ã€‚" });
                    }
                });
            }
        }

        function sendNotification(ratio) {
            if (!("Notification" in window)) return;

            const now = Date.now();
            // 5åˆ†é’Ÿå†·å´æ—¶é—´ (300,000 ms)
            if (now - lastNotifyTime > 300000) {
                if (Notification.permission === "granted") {
                    new Notification(`ğŸ”” é‡‘é“¶æ¯”æé†’: ${ratio.toFixed(2)}`, {
                        body: "å½“å‰é‡‘é“¶æ¯”å·²ä½äºè®¾å®šé˜ˆå€¼ï¼Œè¯·å…³æ³¨å¸‚åœºæœºä¼šï¼",
                        icon: "https://cdn-icons-png.flaticon.com/512/3658/3658959.png" // ç®€å•çš„å›¾æ ‡
                    });
                    lastNotifyTime = now;
                }
            }
        }

        function checkRatio(currentRatio) {
            const target = parseFloat(document.getElementById('targetRatio').value) || 44;
            
            const panel = document.getElementById('ratioPanel');
            const icon = document.getElementById('alert-icon');
            
            if (currentRatio && currentRatio <= target) {
                // è§¦å‘è­¦æŠ¥çŠ¶æ€ï¼šçº¢è‰²é—ªçƒèƒŒæ™¯ + é‡‘è‰²å›¾æ ‡
                panel.classList.add('alert-active');
                icon.classList.add('active'); 
                document.title = `ğŸ”” ${currentRatio.toFixed(2)} - é‡‘é“¶æ¯”æé†’`;
                
                // è§¦å‘æµè§ˆå™¨é€šçŸ¥
                sendNotification(currentRatio);
            } else {
                // å®‰å…¨çŠ¶æ€
                panel.classList.remove('alert-active');
                
                // å…³é”®ä¿®å¤ï¼šå¦‚æœæƒé™å·²å¼€å¯ï¼Œä¿æŒé‡‘è‰²å›¾æ ‡ï¼ˆè¡¨ç¤ºç›‘æ§ä¸­ï¼‰ï¼›å¦åˆ™å˜ç°
                if ("Notification" in window && Notification.permission === "granted") {
                    icon.classList.add('active');
                } else {
                    icon.classList.remove('active');
                }
                
                document.title = 'ç™½é“¶æœŸè´§ï¼šåŠ¨æ€é£æ§ç­–ç•¥è®¡ç®—å™¨ v3.2';
            }
        }

        // å¯åŠ¨å®šæ—¶ä»»åŠ¡
        setInterval(fetchPrices, 10000); // æ¯10ç§’æ›´æ–°ä¸€æ¬¡
        fetchPrices(); // ç«‹å³æ‰§è¡Œä¸€æ¬¡
        
        // é¡µé¢åŠ è½½åæ£€æŸ¥æƒé™çŠ¶æ€
        checkPermissionStatus();

        // === æ ¸å¿ƒè®¡ç®—é€»è¾‘ ===
        function calculateScenario(type, mode, safetyRate) {
            let data = [];
            let p, eq, lots, avg;
            let cfg = CONFIG[type];

            // è¯»å–èµ„é‡‘è°ƒæ•´å€¼
            let adj = 0;
            if (type === 'cn') adj = parseFloat(document.getElementById('cnAdj').value) || 0;
            else adj = parseFloat(document.getElementById('mooAdj').value) || 0;

            if (mode === 'real') {
                // ç°å®æ¨¡å¼ï¼šå…ˆå¡«å…¥å†å²æ•°æ®
                let tempAvg = 0;
                HISTORY[type].forEach((h, idx) => {
                    if (idx === 0) {
                        tempAvg = h.price;
                    } else {
                        let prevH = HISTORY[type][idx-1];
                        let diff = h.lots - prevH.lots;
                        if (diff > 0) {
                            // åªæœ‰åŠ ä»“æ—¶æ‰æ›´æ–°å‡ä»·
                            tempAvg = (tempAvg * prevH.lots + h.price * diff) / h.lots;
                        }
                    }

                    data.push({
                        round: h.round, type: 'history', price: h.price, equity: h.equity, lots: h.lots,
                        avgPrice: tempAvg,
                        note: h.note
                    });
                });

                // æ¥ç€å¡«å…¥å½“å‰çŠ¶æ€ (åº”ç”¨è°ƒæ•´å€¼)
                p = cfg.currentPrice;
                eq = cfg.currentEquity + adj;
                lots = cfg.currentLots;
                
                // ä¿®æ­£ï¼šå¦‚æœå½“å‰æ‰‹æ•°å¤šäºå†å²æœ€åä¸€æ‰‹ï¼Œè¯´æ˜åœ¨å½“å‰ä»·æœ‰åŠ ä»“ï¼Œéœ€è¦æ›´æ–°å‡ä»·
                let lastHistoryLots = HISTORY[type][HISTORY[type].length - 1].lots;
                if (lots > lastHistoryLots) {
                    avg = (tempAvg * lastHistoryLots + p * (lots - lastHistoryLots)) / lots;
                } else {
                    avg = tempAvg; 
                }

                data.push({
                    round: HISTORY[type].length + 1, type: 'current', price: p, equity: eq, lots: lots,
                    avgPrice: avg,
                    note: 'å®é™…æŒä»“(äºæŸ)'
                });
            } else {
                // ç†æƒ³æ¨¡å¼ï¼šä»å¤´å¼€å§‹
                p = cfg.startPrice;
                eq = cfg.startEquity + adj;
                lots = cfg.startLots;
                avg = p;
                
                data.push({
                    round: 1, type: 'history', price: p, equity: eq, lots: lots,
                    avgPrice: avg,
                    note: 'ç†æƒ³å¼€å±€'
                });
            }

            // å‘åæ¨æ¼”30è½®
            let maxRounds = 30;
            // èµ·å§‹è½®æ¬¡ç¼–å·
            let startRoundNum = mode === 'real' ? (HISTORY[type].length + 2) : 2;

            for(let i=0; i<maxRounds; i++) {
                let nextLots = lots + 1;
                let nextPrice = 0;

                // ç»Ÿä¸€ä½¿ç”¨ç™¾åˆ†æ¯”é€»è¾‘è®¡ç®—
                let sz = cfg.contractSize;
                let K = (safetyRate/100) + (1 - safetyRate/100) * cfg.marginRate;
                let num = eq - (lots * sz * p);
                let den = (nextLots * sz * K) - (lots * sz);
                nextPrice = num / den;

                if (nextPrice <= p) nextPrice = p;

                // [v4.1] Check Limit BEFORE pushing
                let limit = (type === 'cn') ? 30400 : 135;
                if (nextPrice > limit) {
                    // Reached limit before needing to add position
                    let finalEq = eq + (limit - p) * lots * sz;
                    data.push({
                        round: '-',
                        type: 'future',
                        price: limit,
                        equity: finalEq,
                        lots: lots,
                        avgPrice: avg,
                        note: 'ç›®æ ‡æ­¢ç›ˆ'
                    });
                    break;
                }

                // æ›´æ–°ä½™é¢
                let newEq = eq + (nextPrice - p) * lots * sz;

                // æ›´æ–°å‡ä»·: (æ—§å‡ä»·*æ—§æ‰‹æ•° + æ–°ä»·æ ¼*1) / æ–°æ‰‹æ•°
                // è¿™é‡Œçš„é€»è¾‘å‡è®¾æ¯æ¬¡åªåŠ 1æ‰‹ï¼Œç¬¦åˆå¾ªç¯å‰æ nextLots = lots + 1
                let newAvg = (avg * lots + nextPrice * 1) / nextLots;

                // è®°å½•æ•°æ®
                data.push({
                    round: startRoundNum + i,
                    type: 'future',
                    price: nextPrice,
                    equity: newEq,
                    lots: nextLots,
                    avgPrice: newAvg,
                    note: nextPrice <= p ? 'ç«‹å³åŠ ä»“' : 'ç­‰å¾…åŠ ä»“'
                });

                p = nextPrice;
                eq = newEq;
                lots = nextLots;
                avg = newAvg;
            }
            return data;
        }

        function calcRisk(type, price, equity, lots, safetyRate) {
            let boomPrice = 0;
            let marginCall = 0;
            let cfg = CONFIG[type];
            let sz = cfg.contractSize;

            // ç»Ÿä¸€é£é™©è®¡ç®—é€»è¾‘ï¼ˆç™¾åˆ†æ¯”ï¼‰
            // çˆ†ä»“ä»·è®¡ç®—ï¼šå‡€å€¼ <= ç»´æŒä¿è¯é‡‘
            // Equity - Loss = Margin
            // Equity - (CurrentPrice - BoomPrice)*Lots*Sz = BoomPrice*Lots*Sz*MarginRate
            // => Equity - CurrentPrice*Lots*Sz + BoomPrice*Lots*Sz = BoomPrice*Lots*Sz*MarginRate
            // => BoomPrice*Lots*Sz*(1 - MarginRate) = CurrentPrice*Lots*Sz - Equity
            // => BoomPrice = (CurrentPrice*Lots*Sz - Equity) / (Lots*Sz*(1 - MarginRate))
            
            boomPrice = (sz * lots * price - equity) / (sz * lots * (1 - cfg.marginRate));
            
            let K = (safetyRate/100) + (1 - safetyRate/100) * cfg.marginRate;
            let target = lots * sz * price * K;
            marginCall = target - equity;
            
            let safePercent = (price - boomPrice) / price * 100;
            return { boomPrice, marginCall, safePercent };
        }

        // === æ¸²æŸ“ä¸äº¤äº’ ===
        function renderTable(type) {
            const safetyRate = parseFloat(document.getElementById('safetyRate').value);
            const mode = state[type];
            const dataset = calculateScenario(type, mode, safetyRate);
            
            let principal = type === 'cn' ? parseFloat(document.getElementById('cnPrincipal').value) : parseFloat(document.getElementById('mooPrincipal').value);

            // [é€»è¾‘ä¼˜åŒ–] å…ˆé‡ç½®æ ‡ç­¾ä¸ºé»˜è®¤çŠ¶æ€ (é˜²æ­¢ä»"å·²æ¸…ä»“"åˆ‡æ¢å›"ç†æƒ³"æ¨¡å¼æ—¶æ ‡ç­¾æœªå¤åŸ)
            document.querySelector(`#${type}-boom-price`).previousElementSibling.innerText = "çˆ†ä»“ä»·æ ¼";
            document.querySelector(`#${type}-next-price`).previousElementSibling.innerText = "ä¸‹ä¸ªåŠ ä»“ä»·";
            document.querySelector(`#${type}-final-equity`).previousElementSibling.innerText = "æœ€ç»ˆæ”¶ç›Š";
            document.getElementById(`${type}-boom-price`).className = "value danger";
            document.getElementById(`${type}-next-price`).className = "value highlight";
            document.getElementById(`${type}-final-equity`).className = "value";
            document.getElementById(`${type}-status`).innerHTML = ``;

            // æ£€æµ‹æ˜¯å¦ä¸º"å·²æ¸…ä»“/å®Œç»“"çŠ¶æ€ (ä»…åœ¨ç°å®æ¨¡å¼ä¸”æŒä»“ä¸º0æ—¶)
            let isCleared = (mode === 'real' && CONFIG[type].currentLots === 0);

            let html = '';
            let finalRow = null;
            let nextAction = null;

            dataset.forEach((row, idx) => {
                // å¦‚æœå·²æ¸…ä»“ï¼Œä¸å†æ˜¾ç¤ºæœªæ¥çš„æ¨æ¼”æ•°æ®
                if (isCleared && row.type === 'future') return;

                if (idx > 0 && row.price === dataset[idx-1].price && row.lots === dataset[idx-1].lots) return;

                let cur = type === 'cn' ? 'Â¥' : '$';
                let risk = calcRisk(type, row.price, row.equity, row.lots, safetyRate);
                let isCurrent = row.type === 'current';
                
                // ä¿æœ¬ä»·è®¡ç®—: BreakEven = Price - (Equity - Principal) / (Lots * Size)
                let breakEven = 0;
                let cushion = 0;
                let breakEvenHtml = '-';
                let cushionTxt = '-';

                // å¤„ç† 0 æŒä»“çš„æƒ…å†µ (é¿å…é™¤ä»¥é›¶)
                if (row.lots > 0) {
                    breakEven = row.price - (row.equity - principal) / (row.lots * CONFIG[type].contractSize);
                    cushion = (row.price - breakEven) / row.price * 100;

                    // æ£€æŸ¥ï¼šå¦‚æœä¿æœ¬ä»· < çˆ†ä»“ä»·ï¼Œè¯´æ˜åˆ©æ¶¦æåš
                    let isSuperSafe = breakEven < risk.boomPrice;
                    
                    if (isSuperSafe) {
                        breakEvenHtml = `<span style="font-weight:bold; color:#4ade80;">${cur}${breakEven.toLocaleString(undefined, {maximumFractionDigits: type==='cn'?0:2})}</span><br><span style="font-size:10px; color:#4ade80;">âœ… çˆ†ä»“äº¦ä¿æœ¬</span>`;
                    } else {
                        breakEvenHtml = `<span style="font-weight:bold; color:${cushion>=0 ? '#fbbf24' : '#ef4444'}">${cur}${breakEven.toLocaleString(undefined, {maximumFractionDigits: type==='cn'?0:2})}</span>`;
                    }

                    cushionTxt = cushion >= 0 ? 
                        `<span class="txt-green">ğŸ›¡ï¸ ${cushion.toFixed(1)}%</span>` : 
                        `<span class="txt-red">ğŸš¨ ${cushion.toFixed(1)}%</span>`;
                } else {
                     breakEvenHtml = '<span style="color:#6b7280">-</span>';
                     cushionTxt = '<span style="color:#6b7280">-</span>';
                }

                let rowClass = isCurrent ? 'row-current' : (mode === 'ideal' ? 'row-ideal' : 'row-future');
                if (row.type === 'history') rowClass = 'row-history';
                if (row.note === 'ç«‹å³åŠ ä»“') rowClass = 'row-trigger';
                if (row.lots === 0 && row.type === 'history') rowClass = 'row-trigger'; // æ¸…ä»“è¡Œé«˜äº®

                let mcTxt = (row.lots > 0 && risk.marginCall > 0) ? 
                    `<span class="txt-red">+${cur}${Math.round(risk.marginCall).toLocaleString()}</span>` : 
                    (row.lots > 0 ? `<span class="txt-green">âœ”</span>` : `-`);

                let boomTxt = (row.lots > 0) ? `${cur}${risk.boomPrice.toLocaleString(undefined, {maximumFractionDigits: type==='cn'?0:2})}` : `-`;
                let safeTxt = (row.lots > 0) ? `${risk.safePercent.toFixed(1)}%` : `-`;
                let safeClass = (row.lots > 0 && risk.safePercent < safetyRate) ? 'txt-red' : 'txt-green';

                html += `<tr class="${rowClass}">
                    <td>${typeof row.round === 'number' ? row.round : '-'}</td>
                    <td>${isCurrent ? 'å½“å‰' : (row.type === 'history' ? 'å·²æ‰§è¡Œ' : (row.price <= CONFIG[type].currentPrice && mode === 'real' ? 'å·²è¿‡' : 'å¾…æ‰§è¡Œ'))}</td>
                    <td>${cur}${row.price.toLocaleString(undefined, {maximumFractionDigits: type==='cn'?0:2})}</td>
                    <td>${row.type==='current' ? 'æŒä»“' : (row.type==='history' ? (row.lots===0?'æ¸…ä»“':'æŒæœ‰'+row.lots+'æ‰‹') : 'å¼€ç¬¬'+row.lots+'æ‰‹')}</td>
                    <td>${row.lots}æ‰‹</td>
                    <td class="txt-blue">${cur}${row.avgPrice.toLocaleString(undefined, {maximumFractionDigits: type==='cn'?0:2})}</td>
                    <td>${cur}${Math.round(row.equity).toLocaleString()}</td>
                    
                    <td>${breakEvenHtml}</td>
                    <td>${cushionTxt}</td>

                    <td class="txt-red">${boomTxt}</td>
                    <td>${mcTxt}</td>
                    <td class="${safeClass}">${safeTxt}</td>
                </tr>`;

                finalRow = row;
                if (!nextAction && row.type === 'future') nextAction = row;
            });

            document.querySelector(`#${type}-table tbody`).innerHTML = html;
            
            let cur = type === 'cn' ? 'Â¥' : '$';

            if (isCleared) {
                // === å®Œç»“çŠ¶æ€é¢æ¿å±•ç¤º ===
                document.getElementById(`${type}-curr-lots`).innerText = "ğŸ å·²è½è¢‹";
                document.getElementById(`${type}-curr-equity`).innerText = cur + Math.round(CONFIG[type].currentEquity).toLocaleString();
                
                // åˆå§‹æŠ•å…¥
                document.querySelector(`#${type}-boom-price`).previousElementSibling.innerText = "åˆå§‹æŠ•å…¥";
                document.getElementById(`${type}-boom-price`).innerText = cur + principal.toLocaleString();
                document.getElementById(`${type}-boom-price`).className = "value"; // ç§»é™¤è­¦å‘Šè‰²

                // ç»å¯¹æ”¶ç›Š
                document.querySelector(`#${type}-next-price`).previousElementSibling.innerText = "ç»å¯¹æ”¶ç›Š";
                let profit = CONFIG[type].currentEquity - principal;
                document.getElementById(`${type}-next-price`).innerText = (profit>=0?"+":"") + cur + profit.toLocaleString(undefined, {maximumFractionDigits: 2});
                document.getElementById(`${type}-next-price`).className = `value ${profit>=0 ? 'txt-green' : 'txt-red'}`;

                // æ€»å›æŠ¥ç‡
                document.querySelector(`#${type}-final-equity`).previousElementSibling.innerText = "æ€»å›æŠ¥ç‡";
                let roi = (profit / principal) * 100;
                document.getElementById(`${type}-final-equity`).innerText = roi.toFixed(1) + "%";
                document.getElementById(`${type}-final-equity`).className = `value ${profit>=0 ? 'txt-green' : 'txt-red'}`;

                document.getElementById(`${type}-status`).innerHTML = `<span class="txt-green font-bold">âœ… ç­–ç•¥å·²å®Œæˆ (Game Over)</span>`;

            } else {
                // === æ­£å¸¸è¿›è¡ŒçŠ¶æ€ ===
                let currRisk = calcRisk(type, mode==='real'?CONFIG[type].currentPrice:CONFIG[type].startPrice, mode==='real'?CONFIG[type].currentEquity:CONFIG[type].startEquity, mode==='real'?CONFIG[type].currentLots:CONFIG[type].startLots, safetyRate);
                
                document.getElementById(`${type}-curr-lots`).innerText = (mode==='real'?CONFIG[type].currentLots:CONFIG[type].startLots) + 'æ‰‹';
                document.getElementById(`${type}-curr-equity`).innerText = cur + Math.round(mode==='real'?CONFIG[type].currentEquity:CONFIG[type].startEquity).toLocaleString();
                document.getElementById(`${type}-boom-price`).innerText = cur + currRisk.boomPrice.toLocaleString(undefined, {maximumFractionDigits: type==='cn'?0:2});
                document.getElementById(`${type}-next-price`).innerText = nextAction ? cur + nextAction.price.toLocaleString(undefined, {maximumFractionDigits: type==='cn'?0:2}) : 'å·²é€šå…³';
                document.getElementById(`${type}-final-equity`).innerText = cur + Math.round(finalRow.equity).toLocaleString();
            }
        }

        function setMode(val) {
            document.getElementById('safetyRate').value = val;
            recalc();
        }

        function setScenario(type, mode) {
            state[type] = mode;
            document.getElementById(`${type}-scen-real`).className = mode === 'real' ? 'scenario-opt active' : 'scenario-opt';
            document.getElementById(`${type}-scen-ideal`).className = mode === 'ideal' ? 'scenario-opt active' : 'scenario-opt';
            renderTable(type);
        }

        function recalc() {
            // æ›´æ–°é…ç½®
            const cnRate = parseFloat(document.getElementById('cnMarginRate').value) || 16;
            CONFIG.cn.marginRate = cnRate / 100;
            CONFIG.cn.boomCoef = 1 - CONFIG.cn.marginRate;

            const mooMarginRate = parseFloat(document.getElementById('mooMarginRate').value) || 9.5;
            CONFIG.moo.marginRate = mooMarginRate / 100;
            CONFIG.moo.boomCoef = 1 - CONFIG.moo.marginRate;

            const safetyRate = parseFloat(document.getElementById('safetyRate').value);
            const isSafeMode = safetyRate >= 15;
            
            document.querySelector('.btn-safe').className = isSafeMode ? 'mode-btn btn-safe active' : 'mode-btn btn-safe';
            document.querySelector('.btn-agg').className = !isSafeMode ? 'mode-btn btn-agg active' : 'mode-btn btn-agg';
            
            const alertBox = document.getElementById('alertBox');
            alertBox.className = isSafeMode ? 'alert-box safe-mode' : 'alert-box agg-mode';
            alertBox.innerHTML = isSafeMode ? 
                `<h3>ğŸ›¡ï¸ ç¨³å¥æ¨¡å¼ (${safetyRate}%)</h3><p>å·²å¯ç”¨é«˜å®‰å…¨è¾¹é™…è®¡ç®—ã€‚è¡¨æ ¼æ–°å¢äº†ã€çˆ†ä»“ä»·ã€‘å’Œã€éœ€è¡¥ä¿ã€‘åˆ—ï¼Œè¯·é‡ç‚¹å…³æ³¨çº¢è‰²æ•°å­—ã€‚</p>` :
                `<h3>ğŸ”¥ æ¿€è¿›æ¨¡å¼ (${safetyRate}%)</h3><p>è¿½æ±‚æè‡´æ•ˆç‡ã€‚æ³¨æ„è§‚å¯Ÿã€éœ€è¡¥ä¿ã€‘åˆ—ï¼Œæ­£æ•°è¡¨ç¤ºæ‚¨å½“å‰èµ„é‡‘ä¸è¶³ä»¥æ”¯æ’‘æ­¤å®‰å…¨å›æ’¤ï¼Œéœ€è¦å…¥é‡‘ã€‚</p>`;

            renderTable('cn');
            renderTable('moo');
        }

        window.onload = function() {
            recalc();
            loadEmailConfig();
        };
    </script>
</body>
</html>